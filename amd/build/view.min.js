define("mod_googlemeet/view",["core/ajax","core/str","core/notification","core/templates","mod_googlemeet/gapi"],(function(Ajax,Str,Notification,Templates,gapi){return{init:function(clientId,apiKey,googlemeet,hasRecording,courseModuleId,hasCapability){let tokenClient,gapiInited=!1,gisInited=!1;var ownerEmail,discoveryDocs=["https://www.googleapis.com/discovery/v1/apis/drive/v3/rest"],meetingCode=googlemeet.url.substr(24,12),notpossiblesync="",notfoundrecordingsfolder="",notfoundrecordingname="",stror="";Str.get_strings([{key:"notpossiblesync",component:"mod_googlemeet"},{key:"notfoundrecordingsfolder",component:"mod_googlemeet"},{key:"notfoundrecordingname",component:"mod_googlemeet"},{key:"or",component:"mod_googlemeet"}]).done((function(strs){notpossiblesync=strs[0],notfoundrecordingsfolder=strs[1],notfoundrecordingname=strs[2],stror=strs[3]})).fail(Notification.exception);var syncDriveButton=document.getElementById("id_syncdrivebutton");async function initializeGapiClient(){await gapi.client.init({apiKey:apiKey,discoveryDocs:discoveryDocs}),gapiInited=!0,maybeEnableButtons()}function maybeEnableButtons(){if(gapiInited&&gisInited)return syncDriveButton.onclick=handleAuthClick,void(syncDriveButton.disabled=!1)}function handleAuthClick(){tokenClient.callback=async resp=>{if(void 0!==resp.error)throw resp;var pre;showLoading(!0),(pre=document.getElementById("googlemeetcontentlog")).style.display="none",pre.innerHTML="",gapi.client.drive.files.list({q:"name='Meet Recordings' and trashed=false",pageSize:1e3,fields:"nextPageToken, files(id,owners)"}).then((function(response){var files=response.result.files;if(files&&files.length>0){var parents="";for(let i=0;i<files.length;i++)isOwnerAndRoomCreator(googlemeet.creatoremail,files[i].owners)&&(ownerEmail=googlemeet.creatoremail,parents+="parents='".concat(files[i].id,"'"),i+1<files.length&&(parents+=" or "));if(parents)return void function(parents){gapi.client.drive.files.list({q:"("+parents+") and trashed=false and mimeType='video/mp4' "+getNameQuery(),pageSize:1e3,fields:"files(id,name,permissionIds,createdTime,videoMediaMetadata,webViewLink)"}).then((function(response){var files=response.result.files;if(files&&files.length>0){for(var i=0;i<files.length;i++){var file=files[i];file.permissionIds.includes("anyoneWithLink")||setPermission(file.id),files[i].recordingId=file.id,files[i].duration=getTimeString(file.videoMediaMetadata.durationMillis),files[i].createdTime=Math.floor(new Date(file.createdTime).getTime()/1e3),delete files[i].id,delete files[i].permissionIds,delete files[i].videoMediaMetadata}Ajax.call([{methodname:"mod_googlemeet_sync_recordings",args:{googlemeetid:googlemeet.id,creatoremail:ownerEmail,files:files,coursemoduleid:courseModuleId}}])[0].then((function(response){renderTemplate(response),hasRecording=!0})).fail(Notification.exception).fail((function(){showLoading(!1)}))}else{var notfoundmsg=notfoundrecordingname+' "'+meetingCode+'" ';googlemeet.originalname&&(notfoundmsg+=stror+' "'+googlemeet.originalname+'"'),appendPre(notfoundmsg),showLoading(!1),hasRecording&&(showLoading(!0),Ajax.call([{methodname:"mod_googlemeet_delete_all_recordings",args:{googlemeetid:googlemeet.id,coursemoduleid:courseModuleId}}])[0].then((function(response){renderTemplate(response),hasRecording=!1,showLoading(!1)})).fail(Notification.exception).fail((function(){showLoading(!1)})))}})).catch((function(error){showLoading(!1),appendPre(JSON.stringify(error.result.error,null,2))}))}(parents);appendPre(notpossiblesync),showLoading(!1)}else appendPre(notfoundrecordingsfolder),showLoading(!1)})).catch((function(error){showLoading(!1),appendPre(JSON.stringify(error.result.error,null,2))}))},null===gapi.client.getToken()?tokenClient.requestAccessToken({prompt:"consent"}):tokenClient.requestAccessToken({prompt:""})}function showLoading(show){var googlemeetSyncImg=document.getElementById("googlemeet_syncimg");show?(googlemeetSyncImg.style.display="flex",syncDriveButton.disabled=!0):(googlemeetSyncImg.style.display="none",syncDriveButton.disabled=!1)}function appendPre(message){var pre=document.getElementById("googlemeetcontentlog"),textContent=document.createTextNode(message+"\n");pre.style.display="block",pre.appendChild(textContent)}function setPermission(fileId){gapi.client.drive.permissions.create({resource:{type:"anyone",role:"reader"},fileId:fileId,fields:"id"}).then().catch()}function getNameQuery(){var query="and (name contains '"+meetingCode+"'";return query+=" or name contains '"+googlemeet.originalname+"')"}function getTimeString(s){var secNum=Math.floor(parseInt(s,10)/1e3),hours=Math.floor(secNum/3600),minutes=Math.floor((secNum-3600*hours)/60),seconds=secNum-3600*hours-60*minutes;return seconds<10&&(seconds="0"+seconds),hours>0?(minutes<10&&(minutes="0"+minutes),hours+":"+minutes+":"+seconds):minutes+":"+seconds}function renderTemplate(recordings){Templates.render("mod_googlemeet/recordingstable",{recordings:recordings,coursemoduleid:courseModuleId,hascapability:hasCapability}).then((function(html,js){showLoading(!1),Templates.replaceNodeContents("#googlemeet_recordings_table",html,js),document.getElementById("id_creatoremail").innerHTML=ownerEmail,document.getElementById("id_lastsync").innerHTML=(new Date).toLocaleString().substr(0,16)})).fail(Notification.exception).fail((function(){showLoading(!1)}))}function isOwnerAndRoomCreator(creatoremail,owners){for(let i=0;i<owners.length;i++)if(!0===owners[i].me)return creatoremail===owners[i].emailAddress;return!1}gapi.load("client",initializeGapiClient),tokenClient=google.accounts.oauth2.initTokenClient({client_id:clientId,scope:"https://www.googleapis.com/auth/drive",callback:""}),gisInited=!0,maybeEnableButtons()}}}));

//# sourceMappingURL=view.min.js.map